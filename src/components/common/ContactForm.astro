---
interface Props {
  title?: string;
  subtitle?: string;
  submitButtonText?: string;
  successMessage?: string;
  errorMessage?: string;
  formId?: string;
  className?: string;
}

const {
  title = "Contact Us",
  subtitle = "We'd love to hear from you!",
  submitButtonText = "Send Message",
  successMessage = "Thank you for your message! We'll get back to you soon.",
  errorMessage = "Sorry, there was an error submitting your form. Please try again or email us directly.",
  formId = "contact-form",
  className = ""
} = Astro.props;
---

<div class={`contact-form-container ${className}`}>
  <div class="max-w-md mx-auto">
    {title && <h3 class="text-2xl font-bold text-txt-p mb-2">{title}</h3>}
    {subtitle && <p class="text-txt-s mb-6">{subtitle}</p>}
    
    <form id={formId} class="space-y-6" data-success-message={successMessage} data-error-message={errorMessage} data-form-id={formId}>
      <!-- Honeypot field - hidden from users but visible to bots -->
      <div style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;">
        <input 
          type="text" 
          name="website" 
          tabindex="-1" 
          autocomplete="off" 
          aria-hidden="true"
        />
      </div>
      
      <!-- Name field -->
      <div>
        <label for={`${formId}-name`} class="block text-base font-semibold text-txt-p mb-2" style="color: var(--color-txt-p) !important; opacity: 1 !important; visibility: visible !important; display: block !important;">
          Full Name *
        </label>
        <input 
          type="text" 
          id={`${formId}-name`}
          name="name" 
          required 
          class="contact-form-input"
          placeholder="Enter your full name"
        />
      </div>
      
      <!-- Email field -->
      <div>
        <label for={`${formId}-email`} class="block text-base font-semibold text-txt-p mb-2" style="color: var(--color-txt-p) !important; opacity: 1 !important; visibility: visible !important; display: block !important;">
          Email Address *
        </label>
        <input 
          type="email" 
          id={`${formId}-email`}
          name="email" 
          required 
          class="contact-form-input"
          placeholder="Enter your email address"
        />
      </div>
      
      <!-- Message field -->
      <div>
        <label for={`${formId}-message`} class="block text-base font-semibold text-txt-p mb-2" style="color: var(--color-txt-p) !important; opacity: 1 !important; visibility: visible !important; display: block !important;">
          Message *
        </label>
        <textarea 
          id={`${formId}-message`}
          name="message" 
          rows="5" 
          required 
          class="contact-form-textarea"
          placeholder="Tell us how we can help you..."
        ></textarea>
      </div>
      
      <!-- reCAPTCHA -->
      <!-- <div class="g-recaptcha" data-sitekey="6LcwsqcrAAAAAORjq69IIyTJW3uD2ZUxScZnUPnO"></div> -->
      
      <!-- Submit button -->
      <button 
        type="submit" 
        class="contact-form-button"
      >
        {submitButtonText}
      </button>
    </form>
    
    <!-- Status messages -->
    <div id={`${formId}-status`} class="mt-6 hidden">
      <div id={`${formId}-success`} class="contact-form-success hidden">
        {successMessage}
      </div>
      <div id={`${formId}-error`} class="contact-form-error hidden">
        {errorMessage}
      </div>
    </div>
  </div>
</div>

<!-- reCAPTCHA script -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
  // Form submission handler
  function initializeForm(formId: string) {
    console.log('üîß Initializing form with ID:', formId);
    const form = document.getElementById(formId) as HTMLFormElement;
    if (!form) {
      console.error('‚ùå Form not found with ID:', formId);
      return;
    }
    console.log('‚úÖ Form found:', form);
    
    const statusDiv = document.getElementById(`${formId}-status`);
    const successDiv = document.getElementById(`${formId}-success`);
    const errorDiv = document.getElementById(`${formId}-error`);
    
    function showMessage(type: string, message: string) {
      if (statusDiv) statusDiv.classList.remove('hidden');
      if (successDiv) successDiv.classList.add('hidden');
      if (errorDiv) errorDiv.classList.add('hidden');
      
      if (type === 'success') {
        if (successDiv) {
          successDiv.classList.remove('hidden');
          successDiv.textContent = message;
        }
      } else {
        if (errorDiv) {
          errorDiv.classList.remove('hidden');
          errorDiv.textContent = message;
        }
      }
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (statusDiv) statusDiv.classList.add('hidden');
      }, 5000);
    }
    
    function resetForm() {
      form.reset();
      // grecaptcha.reset(); // Commented out for now
    }
    
    // Rate limiting check
    function isRateLimited() {

      //Commented out for testing


      // const lastSubmission = localStorage.getItem(`${formId}-last-submission`);
      // if (lastSubmission) {
      //   const timeDiff = Date.now() - parseInt(lastSubmission);
      //   const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds
      //   if (timeDiff < oneHour) {
      //     return true;
      //   }
      // }
      return false;
    }
    
    // Content filtering
    function isSpam(data: any) {
      const spamKeywords = [
        'viagra', 'casino', 'loan', 'click here', 'buy now', 'make money fast',
        'weight loss', 'diet pills', 'free money', 'lottery', 'inheritance',
        'nigerian prince', 'urgent', 'limited time', 'act now'
      ];
      
      const message = data.message.toLowerCase();
      const name = data.name.toLowerCase();
      
      // Check for spam keywords
      if (spamKeywords.some(keyword => message.includes(keyword) || name.includes(keyword))) {
        return true;
      }
      
      // Check for excessive links
      const linkCount = (message.match(/http/g) || []).length;
      if (linkCount > 3) {
        return true;
      }
      
      // Check for excessive caps
      const capsRatio = (message.match(/[A-Z]/g) || []).length / message.length;
      if (capsRatio > 0.7) {
        return true;
      }
      
      // Check for suspicious email patterns
      const suspiciousEmails = ['test@test.com', 'admin@admin.com', 'user@example.com'];
      if (suspiciousEmails.includes(data.email.toLowerCase())) {
        return true;
      }
      
      return false;
    }
    
    // Email validation
    function validateEmail(email: string) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    form.addEventListener('submit', async (e) => {
      console.log('üìù Form submit event triggered!');
      e.preventDefault();
      
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (!submitButton) return;
      
      const originalText = submitButton.textContent || '';
      
      // Show loading state
      submitButton.textContent = 'Sending...';
      submitButton.disabled = true;
      
      try {
        // Check rate limiting
        if (isRateLimited()) {
          throw new Error('Please wait at least 1 hour between submissions');
        }
        
        const formData = new FormData(form);
        
        // Check honeypot field
        if (formData.get('website')) {
          console.log('Bot detected via honeypot');
          throw new Error('Invalid submission detected');
        }
        
        // // Verify reCAPTCHA
        // const recaptchaResponse = grecaptcha.getResponse();
        // if (!recaptchaResponse) {
        //   throw new Error('Please complete the reCAPTCHA verification');
        // }
        
        const data = {
          name: formData.get('name') as string,
          email: formData.get('email') as string,
          message: formData.get('message') as string,
          // recaptchaResponse: recaptchaResponse,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          referrer: document.referrer
        };
        
        // Validate email
        if (!validateEmail(data.email)) {
          throw new Error('Please enter a valid email address');
        }
        
        // Check for spam
        if (isSpam(data)) {
          throw new Error('Message flagged as spam');
        }
        
        // Submit to Google Apps Script
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzQRqAxaJVPL8CgoY8PZVj5lOwrvrT7UDcfI1rQoN0uF99RTlm_k4LAZiU9CpB2ABjW/exec';
        
        console.log('üì§ Submitting form data:', data);
        console.log('üåê Script URL:', scriptUrl);
        
        const response = await fetch(scriptUrl, {
          method: 'POST',
          body: JSON.stringify(data),
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', response.headers);
        
        const result = await response.json();
        console.log('üì• Response result:', result);
        
        if (result.success) {
          const successMsg = form.dataset.successMessage || 'Message sent successfully!';
          showMessage('success', successMsg);
          resetForm();
          
          // Update rate limiting
          localStorage.setItem(`${formId}-last-submission`, Date.now().toString());
        } else {
          throw new Error(result.error || 'Submission failed');
        }
        
      } catch (error: any) {
        console.error('Form submission error:', error);
        const errorMsg = form.dataset.errorMessage || 'An error occurred. Please try again.';
        showMessage('error', error.message || errorMsg);
      } finally {
        // Reset button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    });
  }
  
  // Initialize form when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Find the contact form and get its ID
    const form = document.querySelector('form[data-form-id]');
    if (form) {
      const formId = form.getAttribute('data-form-id');
      console.log('üöÄ DOM loaded, initializing form with ID:', formId);
      if (formId) {
        initializeForm(formId);
      }
    } else {
      console.error('‚ùå No contact form found with data-form-id attribute');
    }
  });
</script>

<style>
  .contact-form-container {
    font-family: 'Quicksand', sans-serif;
  }
  
  /* Input and textarea styling with theme colors - HIGH SPECIFICITY */
  .contact-form-container .contact-form-input,
  .contact-form-container .contact-form-textarea {
    width: 100% !important;
    padding: 12px 16px !important;
    background-color: var(--color-bg-p) !important;
    background-image: none !important;
    border: 3px solid var(--color-border) !important;
    border-radius: 8px !important;
    font-size: 16px !important;
    color: var(--color-txt-p) !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    position: relative !important;
    z-index: 1 !important;
  }
  
  .contact-form-container .contact-form-input::placeholder,
  .contact-form-container .contact-form-textarea::placeholder {
    color: var(--color-txt-s) !important;
    opacity: 1 !important;
  }
  
  .contact-form-container .contact-form-input:focus,
  .contact-form-container .contact-form-textarea:focus {
    outline: none !important;
    border-color: var(--color-border) !important;
    box-shadow: 0 0 0 4px rgba(119, 162, 144, 0.3) !important;
    transform: translateY(-1px) !important;
    background-color: var(--color-bg-p) !important;
  }
  
  .contact-form-container .contact-form-textarea {
    resize: vertical !important;
    min-height: 120px !important;
  }
  
  /* Button styling with theme colors */
  .contact-form-container .contact-form-button {
    width: 100% !important;
    padding: 16px 24px !important;
    background-color: var(--color-border) !important;
    color: var(--color-bg-p) !important;
    border: none !important;
    border-radius: 8px !important;
    font-size: 18px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    position: relative !important;
    z-index: 10 !important;
  }
  
  .contact-form-container .contact-form-button:hover {
    background-color: var(--color-txt-p) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15) !important;
  }
  
  .contact-form-container .contact-form-button:focus {
    outline: none !important;
    box-shadow: 0 0 0 4px rgba(119, 162, 144, 0.3) !important;
  }
  
  .contact-form-container .contact-form-button:disabled {
    opacity: 0.6 !important;
    cursor: not-allowed !important;
    transform: none !important;
  }
  
  /* ULTRA HIGH SPECIFICITY - Override any global button styles */
  .contact-form-container form .contact-form-button,
  .contact-form-container button.contact-form-button,
  .contact-form-container button[type="submit"] {
    background-color: var(--color-border) !important;
    color: var(--color-bg-p) !important;
    border: none !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    position: relative !important;
    z-index: 10 !important;
  }
  
  /* Override any potential theme interference for buttons */
  .light .contact-form-container form .contact-form-button,
  .light .contact-form-container button.contact-form-button,
  .theme-nature .contact-form-container form .contact-form-button,
  .theme-nature .contact-form-container button.contact-form-button {
    background-color: var(--color-border) !important;
    color: var(--color-bg-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  /* Status message styling with theme colors */
  .contact-form-container .contact-form-success {
    padding: 16px !important;
    background-color: var(--color-bg-s) !important;
    border: 2px solid var(--color-border) !important;
    border-radius: 8px !important;
    color: var(--color-txt-p) !important;
    font-weight: 500 !important;
  }
  
  .contact-form-container .contact-form-error {
    padding: 16px !important;
    background-color: rgba(239, 68, 68, 0.2) !important;
    border: 2px solid #ef4444 !important;
    border-radius: 8px !important;
    color: #ef4444 !important;
    font-weight: 500 !important;
  }
  
  /* Hide honeypot field completely */
  .contact-form-container input[name="website"] {
    display: none !important;
  }
  
  /* Ensure labels are visible with theme colors */
  .contact-form-container label {
    color: var(--color-txt-p) !important;
    font-weight: 600 !important;
    font-size: 16px !important;
    margin-bottom: 8px !important;
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  /* Light theme overrides */
  .light .contact-form-container label {
    color: var(--color-light-txt-p) !important;
  }
  
  /* Nature theme overrides */
  .theme-nature .contact-form-container label {
    color: var(--color-nature-txt-p) !important;
  }
  
  /* ULTRA HIGH SPECIFICITY - Override any global label styles */
  .contact-form-container form label,
  .contact-form-container label[for] {
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
  }
  
  /* MAXIMUM SPECIFICITY - Target specific label IDs */
  .contact-form-container label[for*="-name"],
  .contact-form-container label[for*="-email"],
  .contact-form-container label[for*="-message"] {
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    font-weight: 600 !important;
    font-size: 16px !important;
    margin-bottom: 8px !important;
  }
  
  /* Force label visibility with all possible selectors */
  .contact-form-container .block.text-base.font-semibold.text-txt-p.mb-2,
  .contact-form-container div > label,
  .contact-form-container form div label {
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    font-weight: 600 !important;
    font-size: 16px !important;
    margin-bottom: 8px !important;
  }
  
  /* ULTRA HIGH SPECIFICITY - Override any global styles */
  .contact-form-container form .contact-form-input,
  .contact-form-container form .contact-form-textarea {
    background: var(--color-bg-p) !important;
    background-color: var(--color-bg-p) !important;
    background-image: none !important;
    -webkit-background-clip: unset !important;
    background-clip: unset !important;
    border: 3px solid var(--color-border) !important;
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    position: relative !important;
    z-index: 10 !important;
  }
  
  /* Override any potential theme interference with maximum specificity */
  .light .contact-form-container form .contact-form-input,
  .light .contact-form-container form .contact-form-textarea,
  .theme-nature .contact-form-container form .contact-form-input,
  .theme-nature .contact-form-container form .contact-form-textarea {
    background: var(--color-bg-p) !important;
    background-color: var(--color-bg-p) !important;
    border: 3px solid var(--color-border) !important;
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    position: relative !important;
    z-index: 10 !important;
  }
  
  /* Override any Tailwind form styles */
  .contact-form-container input[type="text"],
  .contact-form-container input[type="email"],
  .contact-form-container textarea {
    background-color: var(--color-bg-p) !important;
    border: 3px solid var(--color-border) !important;
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  /* Force visibility with !important on all possible selectors */
  .contact-form-container .contact-form-input,
  .contact-form-container .contact-form-textarea,
  .contact-form-container input.contact-form-input,
  .contact-form-container textarea.contact-form-textarea {
    background-color: var(--color-bg-p) !important;
    border: 3px solid var(--color-border) !important;
    color: var(--color-txt-p) !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
  }
</style>
